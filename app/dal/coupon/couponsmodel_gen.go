// Code generated by goctl. DO NOT EDIT.
// versions:
//  goctl version: 1.9.2

package coupon

import (
	"context"
	"database/sql"
	"fmt"
	"strings"
	"time"

	"github.com/zeromicro/go-zero/core/stores/builder"
	"github.com/zeromicro/go-zero/core/stores/cache"
	"github.com/zeromicro/go-zero/core/stores/sqlc"
	"github.com/zeromicro/go-zero/core/stores/sqlx"
	"github.com/zeromicro/go-zero/core/stringx"
)

var (
	couponsFieldNames          = builder.RawFieldNames(&Coupons{})
	couponsRows                = strings.Join(couponsFieldNames, ",")
	couponsRowsExpectAutoSet   = strings.Join(stringx.Remove(couponsFieldNames, "`id`", "`create_at`", "`create_time`", "`created_at`", "`update_at`", "`update_time`", "`updated_at`"), ",")
	couponsRowsWithPlaceHolder = strings.Join(stringx.Remove(couponsFieldNames, "`id`", "`create_at`", "`create_time`", "`created_at`", "`update_at`", "`update_time`", "`updated_at`"), "=?,") + "=?"

	cacheCouponsIdPrefix = "cache:coupons:id:"
)

type (
	couponsModel interface {
		Insert(ctx context.Context, data *Coupons) (sql.Result, error)
		FindOne(ctx context.Context, id int64) (*Coupons, error)
		Update(ctx context.Context, data *Coupons) error
		Delete(ctx context.Context, id int64) error
	}

	defaultCouponsModel struct {
		sqlc.CachedConn
		table string
	}

	Coupons struct {
		Id              int64     `db:"id"`               // 券模板ID
		CouponType      int64     `db:"coupon_type"`      // 券类型 1-现金券 2-折扣券 3-免邮券
		DiscountAmount  int64     `db:"discount_amount"`  // 抵扣金额(分)，折扣券为上限
		DiscountPercent int64     `db:"discount_percent"` // 折扣百分比
		MinSpendAmount  int64     `db:"min_spend_amount"` // 使用门槛(分)
		TotalQuantity   int64     `db:"total_quantity"`   // 发券总量(0不限)
		PerUserLimit    int64     `db:"per_user_limit"`   // 每人限领数量(0不限)
		IssuedQuantity  int64     `db:"issued_quantity"`  // 已发放数量
		StartAt         time.Time `db:"start_at"`         // 有效期开始时间
		EndAt           time.Time `db:"end_at"`           // 有效期结束时间
		Source          string    `db:"source"`           // 来源
		Remarks         string    `db:"remarks"`          // 备注
		CreatedAt       time.Time `db:"created_at"`
		UpdatedAt       time.Time `db:"updated_at"`
	}
)

func newCouponsModel(conn sqlx.SqlConn, c cache.CacheConf, opts ...cache.Option) *defaultCouponsModel {
	return &defaultCouponsModel{
		CachedConn: sqlc.NewConn(conn, c, opts...),
		table:      "`coupons`",
	}
}

func (m *defaultCouponsModel) Delete(ctx context.Context, id int64) error {
	couponsIdKey := fmt.Sprintf("%s%v", cacheCouponsIdPrefix, id)
	_, err := m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (result sql.Result, err error) {
		query := fmt.Sprintf("delete from %s where `id` = ?", m.table)
		return conn.ExecCtx(ctx, query, id)
	}, couponsIdKey)
	return err
}

func (m *defaultCouponsModel) FindOne(ctx context.Context, id int64) (*Coupons, error) {
	couponsIdKey := fmt.Sprintf("%s%v", cacheCouponsIdPrefix, id)
	var resp Coupons
	err := m.QueryRowCtx(ctx, &resp, couponsIdKey, func(ctx context.Context, conn sqlx.SqlConn, v any) error {
		query := fmt.Sprintf("select %s from %s where `id` = ? limit 1", couponsRows, m.table)
		return conn.QueryRowCtx(ctx, v, query, id)
	})
	switch err {
	case nil:
		return &resp, nil
	case sqlc.ErrNotFound:
		return nil, ErrNotFound
	default:
		return nil, err
	}
}

func (m *defaultCouponsModel) Insert(ctx context.Context, data *Coupons) (sql.Result, error) {
	couponsIdKey := fmt.Sprintf("%s%v", cacheCouponsIdPrefix, data.Id)
	ret, err := m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (result sql.Result, err error) {
		query := fmt.Sprintf("insert into %s (%s) values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)", m.table, couponsRowsExpectAutoSet)
		return conn.ExecCtx(ctx, query, data.CouponType, data.DiscountAmount, data.DiscountPercent, data.MinSpendAmount, data.TotalQuantity, data.PerUserLimit, data.IssuedQuantity, data.StartAt, data.EndAt, data.Source, data.Remarks)
	}, couponsIdKey)
	return ret, err
}

func (m *defaultCouponsModel) Update(ctx context.Context, data *Coupons) error {
	couponsIdKey := fmt.Sprintf("%s%v", cacheCouponsIdPrefix, data.Id)
	_, err := m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (result sql.Result, err error) {
		query := fmt.Sprintf("update %s set %s where `id` = ?", m.table, couponsRowsWithPlaceHolder)
		return conn.ExecCtx(ctx, query, data.CouponType, data.DiscountAmount, data.DiscountPercent, data.MinSpendAmount, data.TotalQuantity, data.PerUserLimit, data.IssuedQuantity, data.StartAt, data.EndAt, data.Source, data.Remarks, data.Id)
	}, couponsIdKey)
	return err
}

func (m *defaultCouponsModel) formatPrimary(primary any) string {
	return fmt.Sprintf("%s%v", cacheCouponsIdPrefix, primary)
}

func (m *defaultCouponsModel) queryPrimary(ctx context.Context, conn sqlx.SqlConn, v, primary any) error {
	query := fmt.Sprintf("select %s from %s where `id` = ? limit 1", couponsRows, m.table)
	return conn.QueryRowCtx(ctx, v, query, primary)
}

func (m *defaultCouponsModel) tableName() string {
	return m.table
}
